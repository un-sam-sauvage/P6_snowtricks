{% extends "base.html.twig" %}
{% block stylesheets %}
<style>
	#welcome-message {
		background-color: #ecaf9f;
		width: 100%;
		height: 44vw;
		font-size: 4vw;
		color: #534741;
		text-align: center;
		display: flex;
		flex-direction: column;
		justify-content: space-evenly;
		align-items: center;
		position: relative;
	}
	#go-to-post {
		position: absolute;
		right: 2%;
		bottom: 3%;
		color: #534741;
		font-size: 2vw;
		background-color: #f4f1de;
		border-radius: 100px;
		padding: 0 1%;
	}
	#welcome-message > p {
		margin: 0;
	}
	#posts {
		padding: 5%
	}
	#posts-container {
		display: grid;
		grid-template-columns: auto auto auto auto auto;
		justify-content: space-evenly;
		row-gap: 20px;
	}
	.post-card {
		background-color: #81b29a;
		color: #3d405b;
		border: 1px solid #638475;
		border-radius: 23px;
		padding: 2%;
		width: 300px;
		height: 200px;
		position: relative;
	}
	.post-title {
		font-weight: bold;
		text-transform: uppercase;
		margin-bottom: 0;
	}
	.post-img-container > img {
		width: 100%;
		aspect-ratio: 5/2.5;
		object-fit: contain;
	}
	.post-bottom-card{
		margin-top: 5%;
		display: flex;
		align-items: end;
		justify-content: space-between;
		padding: 0 2%
	}
	.delete-post{
		cursor: pointer;
		transition: color .15s ease-in-out;
	}
	.delete-post:hover {
		color: red;
	}
</style>
{% endblock %}
{% block body %}
	{# {{parent()}} permet d'appeler le contenu du block de base sinon, l'écrase.#}
	<div id="welcome-message">
		<p>Welcome {% if app.user %}{{app.user.username}}{% endif %} on <span style="font-weight:bold; text-decoration: underline;">SNOWTRICKS</span></p>
		<p>A community forum where you can share awesome tricks from snow sports !</p>
		<a id="go-to-post" href="#posts"><i class="fa-solid fa-arrow-down"></i></a>
	</div>
	<div id="posts">
		<h1>LAST POSTS</h1>
		<div id="posts-container">
			{% for post in posts %}
				<div class="post-card">
					<div class="post-img-container">
						{% set break = false %}
						{% for media in post.medias %}
							{% if not break  %}
								{% if not media.isVideo %}
									<img src="{{ asset('uploads/pictures/' ~ media.path) }}">
									{% set break = true %}
								{% endif %}
							{% endif %}
						{% endfor %}
						{% if not break %}
									<img src="{{ asset('uploads/pictures/defaultPicture.png') }}">
						{% endif %}
						
					</div>
					{# TODO: afficher les boutons pour supprimer ou modifier un post en fonction de si on est un auteur ou un admin #}
					<div class="post-bottom-card">
						<a class="post-title" href="/posts/{{post.id}}">{{ post.name }}</a>
						{% if isAdmin %}
						<span class="delete-post"><i class="fa-solid fa-trash"></i></span>
						<input type="hidden" data-id-post="{{post.id}}">
						{% endif %}
					</div>
				</div>
			{% endfor %}
		</div>
	</div>
	<button id="btn_load-more-posts" class="btn btn-primary">Load more posts</button>
	{% if isAdmin %}
	<div id="popup-confirm-delete" style="display: none">
		<p id="popup-text-confirm">Are you sure to delete the post named: <span id="popup-name-post"></span></p>
		<input type="hidden" id="popup-id-post-to-delete">
		<button id="popup-confirm" class="btn btn-primary">Yes</button>
		<button id="popup-cancel" class="btn btn-secondary">No</button>
	</div>
	{% endif %}
	
{% endblock %}
{% block javascripts %}
	<script>
		let offset = 1;

		document.getElementById("btn_load-more-posts").addEventListener("click", btn => {
			btn.preventDefault();
			offset ++;
			getPost(offset);
		})
		//function qui permet de récupérer la suite des posts en AJAX
		function getPost (offset) {
			fetch("getPost", {
				method: "POST",
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					offset : offset,
				})
			}).then(res => {
				return res.json()
			}).then(data => {
				console.log(data.posts);
			}).catch(error => {
				console.error(error);
			})
		}

		{% if isAdmin %}
		document.querySelectorAll(".delete-post").forEach(btnDelete => {
			btnDelete.addEventListener("click", btnClicked => {
				let postName = btnClicked.target.parentNode.querySelector(".post-title").textContent;
				document.getElementById("popup-confirm-delete").style.display = "block";
				document.getElementById("popup-name-post").textContent = postName;
				document.getElementById("popup-id-post-to-delete").value = btnClicked.target.parentNode.querySelector("data-id-post").value
			})
		})

		document.getElementById("popup-confirm").addEventListener("click", btn => {
			btn.preventDefault();
			//TODO: comment fetch par le nom de la route tout en passant des paramètre ?
			fetch("/delete", {
				method: "POST",
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					postId : document.getElementById("popup-id-post-to-delete").value,
				})
			}).then(res => {
				return res.json()
			}).then(data => {
				console.log(data.msg);
			}).catch(error => {
				console.error(error);
			})
		})

		document.getElementById("popup-cancel").addEventListener("click", btn => {
			btn.preventDefault();
			document.getElementById("popup-confirm-delete").style.display = "none";
		})
		{% endif %}
	</script>
{% endblock %}
